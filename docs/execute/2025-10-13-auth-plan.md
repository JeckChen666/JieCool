# 单用户 Token 鉴权行动大纲（GoFrame + 前端拦截器）

目标：为当前系统加入“仅我本人可登录”的简化鉴权体系，用 Token 模式区分「仅我可见」与「所有人可见」的资源；支持多端同时在线；当我修改密码时，所有既有在线会话强制失效、需重新登录。

## 参考资料（仓库内）
- GoFrame JWT 示例：docs/server/goframe_doc/examples/httpserver/jwt/jwt.md
- StarBook 课程：
  - 登录生成 Token：docs/server/goframe_doc/course/starbook/第三章-会话管理/3.2.登录.md
  - 统一 Auth 中间件：docs/server/goframe_doc/course/starbook/第三章-会话管理/3.3.获取用户信息.md
- 路由中间件拦截器概览：docs/server/goframe_doc/docs/WEB服务开发/路由管理/路由管理-中间件拦截器/路由管理-中间件拦截器.md
- 社区文章（RBAC 供延伸参考，当前需求为单用户不需复杂角色表）：docs/server/goframe_doc/community/社区投稿/为Go应用增加完整的权限认证能力.md

## 鉴权方案概述
- 鉴权模型：单用户登录，使用 JWT（HS256）作为访问令牌；不限制设备数量（多端可同时在线）。
- 失效策略：当“动态配置中的密码”更新时，令牌统一失效。实现方式：在令牌校验中比较 token 的签发时间（iat）与配置中的密码更新时间（password_updated_at）；若 iat < password_updated_at，则判定未授权。
- 公开/私有资源边界：
  - 公共接口：无需登录即可访问（如访客统计、每日一句公开信息等，最终以模块清单为准）。
  - 私有接口：需要携带 Authorization: Bearer <token>，JWT 中间件验证通过后放行。
- 错误码约定：统一返回业务码“未授权”，前端看到该码直接跳登录页。
  - 建议业务码：Unauthorized = 40100（HTTP 状态可保持 200，由统一响应中间件承载业务码；或直接用 401）。

## 后端（GoFrame）行动项
1) 需求落盘与配置
   - 在“动态配置”中新增/确认以下字段：
     - owner_password（存储加密后的口令，而非明文）
     - password_updated_at（时间戳，更新密码时写入当前时间）
     - jwt_secret（随机生成的签名密钥）
     - jwt_expire_hours（令牌有效期，建议 24-168 小时可配）
   - 密码加密建议：使用 bcrypt/argon2 等算法存储，不存明文。

2) 接口元数据驱动的鉴权（基于 g.Meta）
   - 约定：通过 API 入参结构体的 g.Meta 标签定义是否需要鉴权。
     - 例如：
       - 公共接口：g.Meta `path:"/..." method:"get" noAuth:"true"`
       - 私有接口（默认）：不写 noAuth 或写 noAuth:"false"。
   - 中间件读取方式：在中间件中使用 r.GetServeHandler() 拿到当前 HandlerItem，并通过 HandlerItem 的元数据获取方法（参考 docs/server/goframe_doc/community/社区投稿/为Go应用增加完整的权限认证能力.md 的说明“通过 HandlerItem 的 GetMetaTag 获取接口元数据”）读取 noAuth 标签；若为 true 则跳过鉴权直接放行。
   - 说明：g.Meta 的元数据能力详见 docs/server/goframe_doc/docs/组件列表/实用工具/元数据-gmeta.md。

3) 接口与路由
   - 新增认证接口：
     - POST /auth/login：参数 password；校验通过后签发 JWT，返回 { token }
     - GET  /auth/me：返回当前登录者的基本信息（固定为本人），用于前端校验登录态
     - POST /auth/logout（可选）：前端本地清除即可；如需强制全端下线可结合“会话版本”策略
   - 路由分组：
     - /api/public/*（不鉴权）
     - /api/private/*（应用 JWT 中间件鉴权）

4) JWT 中间件
   - 从请求头 Authorization 解析 Bearer Token
   - 验证签名（HS256 + jwt_secret）与过期时间（exp）
   - 比较 iat 与 password_updated_at，若 iat < password_updated_at 则返回未授权业务码
   - 将身份信息写入请求上下文（如 userId/sub=owner），r.Middleware.Next() 放行
   - 返回格式：统一使用项目既有响应格式与错误码体系（参考 ghttp.MiddlewareHandlerResponse 与示例文档）
   - 鉴权开关（g.Meta）：若当前接口 g.Meta 中存在 `noAuth:"true"`，则跳过以上校验直接放行；否则执行 JWT 校验。

5) URL token 静默登录能力
   - 需求：在 URL 上携带特定 token 参数时，自动完成本次请求的登录鉴权（并可选择持久化后续请求）。
   - 设计方案：
     - 约定 Query 参数名为 `token`（可在动态配置中自定义如 login_link_token_param_name）。
     - 中间件流程：
       1. 在读取 Authorization 之前，先检查 `r.GetQuery("token")` 是否存在；若存在则按 Bearer Token 规则进行校验（与普通 JWT 同口径、同密钥、同失效策略）。
       2. 若校验通过，将其视作当前请求的有效令牌（与 Authorization 优先级相同或更高）。
       3. 可选：将该令牌下发到响应的 Set-Cookie 或返回前端，前端持久化以便后续请求无需再次通过 URL 传递（建议由前端在拿到 token 后存入 localStorage）。
     - 安全说明：URL 携带 token 存在泄露风险（例如 Referer、浏览器历史、日志）；建议：
       - 将该能力开关化（如 login_link_token_enabled），默认关闭，仅在特定场景开启。
       - 设置较短的过期时间或专用的“一次性登录链接”令牌（如结合额外 claim 限定用途）。
       - 强制 HTTPS，避免网络层明文泄露。

6) 密码修改联动
   - 在“动态配置更新密码”的逻辑中，除更新 owner_password 外，同时写入 password_updated_at = now()
   - 该变更会让所有旧令牌瞬时失效（因 iat < password_updated_at）

7) 权限边界梳理
   - 逐模块标注接口归属：public/private
   - 对管理操作（如文件删除、配置刷新、微博发布等）统一进入 /api/private 并受中间件保护

8) 安全与风控
   - 登录接口限流与错误次数记录（防暴力破解）
   - 强制 HTTPS（生产）
   - jwt_secret 仅存于服务端配置，不向客户端泄露
   - 令牌最小权限：仅标识“我本人”身份，不承载多余敏感信息

## 前端（Next.js）行动项
1) 登录页与状态
   - 增加登录页面与表单（仅密码）
   - 登录成功将 token 存储于 localStorage（或 cookie，仅前端可读）

2) 请求拦截器
   - 请求前拦截器：自动在需要鉴权的接口上附加 Authorization: Bearer <token>
   - 响应拦截器：如后端返回“未授权业务码（40100）或 HTTP 401”，则：
     - 清理本地 token
     - 跳转至登录页（无需更多鉴权行为）

3) 路由守卫（可选）
   - 对需私有访问的页面（如管理控制台）在页面级做登录态检测与重定向

4) 静默登录（URL token）支持
   - 在应用初始化或受保护页面加载时，检测 URL 上是否存在 `token` 参数；存在则：
     - 将该 token 先行校验后持久化至 localStorage（或 cookie），并移除 URL 上的 token 参数（避免泄露与重复使用）。
     - 后续请求统一走 Authorization 头部，无需继续在 URL 上携带。

## 错误码与统一响应
- 定义 Unauthorized 业务码（40100），message: 未授权
- 后端中间件在鉴权失败时以统一响应体返回该码（与现有 gerror/gcode 使用保持一致）

## 测试清单
- 未登录访问 /api/private/* 返回未授权码，前端跳转登录
- 登录获取 token 后访问私有接口成功
- 多端同时持有 token 可正常访问
- 修改密码后，旧 token 访问立即未授权，需重新登录
- token 过期后未授权
- 登录限流与错误提示正确

## 实施里程碑
1) 后端：配置项与中间件脚手架（JWT 校验 + iat 与 password_updated_at 比较）
2) 后端：/auth/login 与 /auth/me 接口完成；私有路由分组应用中间件
3) 前端：登录页与请求/响应拦截器完成；未授权自动跳转
4) 后端：动态配置“修改密码”联动 password_updated_at
5) 权限边界梳理与公共/私有接口标注；联调与 E2E 测试

## 备选与扩展
- 如需“即时全端下线”而非依赖 iat，可在动态配置添加 session_version，每次密码变更时自增；JWT 增加 claim: sv，校验当前 sv 不一致则失效。
- 可引入 Refresh Token 与短期 Access Token，提升安全性（当前单用户场景可不必）。

——
以上行动大纲将作为后续实现步骤的依据，下一步将从“后端 JWT 中间件与认证接口”开始逐步落地。