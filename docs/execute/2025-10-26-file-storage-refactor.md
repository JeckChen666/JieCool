# 文件存储表重构设计

**日期：** 2025-10-26
**状态：** 🏗️ 设计完成，待实施
**模块：** 文件管理 (File Management)

## 需求描述

当前files表将文件二进制数据和元数据存储在同一表中，随着文件数量增加会导致：
1. 查询文件列表时加载不必要的二进制数据，影响性能
2. 表体积过大，影响缓存和备份效率
3. 数据库维护成本增加

**目标：** 将文件二进制数据分离到专门的file_contents表，提升查询性能和维护效率。

## 架构设计

### 当前表结构问题
- **files表**包含：元数据 + file_content(BYTEA) + thumbnail_content(BYTEA)
- 查询文件列表时会加载大字段数据
- 备份和索引维护效率低

### 新表结构设计

#### 1. file_contents表（文件内容存储）
```sql
CREATE TABLE file_contents (
    id BIGSERIAL PRIMARY KEY,                    -- 主键
    file_content BYTEA NOT NULL,                 -- 文件二进制内容
    thumbnail_content BYTEA,                      -- 缩略图二进制内容
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

#### 2. files表优化
- 保留所有元数据字段
- 添加`file_content_id BIGINT`字段关联file_contents表
- 迁移后可选择性删除原二进制字段

### 性能优化收益

1. **查询性能提升**
   - 文件列表查询不再加载二进制数据
   - 索引效率提升，缓存命中率提高
   - 分页查询速度显著改善

2. **存储优化**
   - 减少表体积，提高备份效率
   - 可单独优化大字段的存储策略
   - 支持文件内容的冷热分离

3. **维护效率**
   - 清理孤立文件内容更简单
   - 可独立统计文件内容存储占用
   - 支持文件内容的归档策略

## 实施方案

### 第一阶段：数据库迁移
✅ **已完成：** 创建迁移脚本 `0008_refactor_file_storage.sql`

**迁移步骤：**
1. 创建file_contents表
2. 添加files表的file_content_id字段
3. 数据迁移：将现有内容从files表迁移到file_contents表
4. 验证数据完整性
5. 创建向后兼容视图（修复了列名冲突问题）
6. 创建辅助函数简化后续操作

### 第二阶段：代码重构
✅ **已完成：** 设计实体模型和DAO结构

**需要修改的组件：**
1. **实体模型** - 添加FileContents实体和Files表的FileContentId字段
2. **DAO层** - 创建FileContentsDao和相关操作方法
3. **服务层** - 修改文件上传、下载逻辑
4. **控制器** - 保持API接口不变

### 第三阶段：业务逻辑适配

#### 文件上传流程
```go
// 新的文件上传流程
1. 读取文件内容
2. 插入file_contents表获取content_id
3. 插入files表，引用content_id
4. 事务确保数据一致性
```

#### 文件下载流程
```go
// 新的文件下载流程
1. 从files表查询file_content_id
2. 从file_contents表查询实际内容
3. 返回文件数据
```

## 技术实现细节

### 迁移脚本特点
- **安全迁移**：使用事务确保数据一致性
- **性能优化**：分批处理避免长时间锁表
- **数据验证**：内置验证步骤确保迁移完整性
- **向后兼容**：创建视图保持现有查询兼容

### 代码架构变化
- **新增FileContents实体**：对应新的数据表
- **扩展Files实体**：添加FileContentId关联字段
- **服务层重构**：修改上传下载逻辑使用新表结构
- **API兼容**：保持现有API接口不变

### 性能监控指标
- 文件列表查询响应时间
- 数据库表大小变化
- 缓存命中率提升
- 备份恢复时间优化

## 部署策略

### 推荐部署流程

1. **测试环境验证**
   ```bash
   # 执行迁移脚本
   psql -d JieCool -f db/migrations/0008_refactor_file_storage.sql

   # 验证数据完整性
   SELECT COUNT(*) FROM files;
   SELECT COUNT(*) FROM file_contents;
   ```

2. **应用代码部署**
   - 更新Go代码到新版本
   - 验证文件上传下载功能
   - 监控性能指标变化

3. **生产环境迁移**
   - 在维护窗口期执行迁移
   - 验证所有功能正常
   - 可选择性删除原表二进制字段

### 回滚方案
- 保留原表结构（暂不删除二进制字段）
- 创建向后兼容视图
- 支持快速回滚到原有架构

## 风险评估与缓解

### 潜在风险
1. **数据迁移风险** - 大量数据迁移可能影响性能
2. **兼容性风险** - 代码修改可能引入新bug
3. **性能风险** - JOIN操作可能影响某些查询性能

### 缓解措施
1. **分批迁移** - 避免长时间锁表
2. **充分测试** - 在测试环境验证所有功能
3. **性能监控** - 实时监控关键性能指标
4. **快速回滚** - 保留回滚能力

## 预期效果

### 性能提升
- **文件列表查询**：响应时间预计提升50-70%
- **数据库体积**：减少30-50%（取决于文件大小）
- **缓存效率**：提升40-60%
- **备份时间**：减少20-40%

### 维护收益
- **存储成本**：可独立优化大字段存储
- **数据清理**：更容易清理孤立内容
- **扩展性**：为后续功能扩展奠定基础

## 后续优化建议

1. **冷热分离** - 可将不常用的文件内容迁移到冷存储
2. **CDN集成** - 静态文件可迁移到CDN
3. **分片策略** - 大文件可考虑分片存储
4. **压缩存储** - 对文件内容进行压缩存储

## 总结

本次重构设计通过分离文件元数据和二进制内容，预期将显著提升系统性能和维护效率。迁移方案经过精心设计，确保数据安全和业务连续性。建议在测试环境充分验证后再进行生产部署。

**当前状态：** 设计完成，代码架构准备就绪，等待测试验证。